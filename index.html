<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F_B</title>
    <link rel="stylesheet" href="main.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300&display=swap" rel="stylesheet">
</head>
<body>

<div class="container"> 
   <canvas id="canvas"></canvas>
   <div class="clean-btn">limpiar lienzo</div>
</div>

<div class="interface">
    <h1 id="birthday-text">Toca para sembrar flores</h1>
    <p id="sub-text">Y mira cómo florece tu día</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script type="x-shader/x-fragment" id="fragmentShader">
    varying vec2 vUv;
    uniform float u_ratio;
    uniform vec2 u_cursor;
    uniform float u_stop_time;
    uniform float u_clean;
    uniform vec2 u_stop_randomizer;
    uniform sampler2D u_texture;
    uniform float u_global_time;

    #define PI 3.14159265359

    vec3 hsv2rgb(vec3 c) {
        vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
        vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
        return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
    }

    float snoise(vec2 v) {
        return fract(sin(dot(v, vec2(12.9898, 78.233))) * 43758.5453);
    }

    void main() {
        vec2 uv = vUv;
        uv.x *= u_ratio;
        vec2 cursor = u_cursor;
        cursor.x *= u_ratio;

        vec2 pos = uv - cursor;
        float r = length(pos);
        float a = atan(pos.y, pos.x);

        // Geometría de pétalos avanzada
        float petals = 5.0 + floor(u_stop_randomizer.y * 4.0);
        float v = abs(cos(a * petals * 0.5 + sin(r * 10.0) * 0.5));
        float f = smoothstep(0.0, 1.0, v) * 0.1 + 0.03;
        
        // Máscaras de la flor
        float flowerMask = smoothstep(f, f - 0.02, r);
        float centerMask = smoothstep(0.02, 0.01, r);
        float glow = exp(-r * 15.0) * 0.4; // Aura luminosa

        // Colores
        vec3 petalCol = hsv2rgb(vec3(u_stop_randomizer.x, 0.6, 1.0));
        vec3 finalCol = mix(petalCol, vec3(1.0, 1.0, 0.8), centerMask);
        finalCol += glow * petalCol; // Añadir brillo

        // Feedback loop (Ping-pong)
        vec4 prev = texture2D(u_texture, vUv);
        float appear = smoothstep(0.6, 0.0, u_stop_time);
        
        // Efecto de desvanecimiento muy lento (0.995 para que dure)
        vec3 base = prev.rgb * 0.997; 

        if (u_clean > 0.5) {
            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
        } else {
            gl_FragColor = vec4(base + (finalCol * flowerMask * appear), 1.0);
        }
    }
</script>

<script type="x-shader/x-vertex" id="vertexShader">
    varying vec2 vUv;
    void main() { vUv = uv; gl_Position = vec4(position, 1.0); }
</script>

<script src="main.js"></script>
</body>
</html>